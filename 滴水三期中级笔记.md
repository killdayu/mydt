# 滴水三期中级笔记

看了视频没怎么理清楚,所以写笔记理一下思路.可能以后玩会了就不写笔记了.

有2个原则:

1.只写我的理解,没理解到的不写.

2.先写通用的,后面要用到了再写特殊的.

------

环境配置:

 [双机调试_windbg.pdf](双机调试_windbg.pdf) 

## 1.保护模式

x86 CPU的3个模式:实模式,保护模式和虚拟8086模式.

建议先参考王爽的汇编语言,我3年前的笔记https://note.youdao.com/s/y3jcBKz.

------

由于历史遗留原因,8086所采用的20位地址总线,寻址地址达到了2的20次方,即1MB.但是由于采用的是16位架构,其他通用寄存器只能达到2的16次方寻址,即64KB.所以采用了段加偏移的方式来寻址,即段地址x16+偏移地址=物理地址.这一点在x86保护模式下也采用了,只不过32位的通用寄存器可以直接寻址所有地址,段寄存器的主要作用变为了权限控制,比如代码段可读可执行不可写,数据段可读可写不可执行.

在x86架构下的段寄存器有96位,但是只有16位可以直接改变.剩下的80位不能直接改变.

结构如下:

```c++
class SegMent
{
public:
	WORD Selector;		//段选择子

private:
	WORD Attributes;	//权限
	DWORD Base;			//基址
	DWORD Limit;		//段长度

};
```

由于不能直接改变段寄存器,所以我们只能间接的通过一张表来进行更改段寄存器,即全局描述符表(GPT,Global Descriptor Table),还有另外一张表,局部描述符表(LPT,Local Descriptor Table),Windows并没有用上.

```assembly
mov ax,es	//复制Selector到ax.
mov es,ax	//通过Selector查找GPT,然后加载GTPT对于的表到es.
//除了mov指令还有LES,LSS,LDS,LFS,LGS等指令可以修改段寄存器,还没有学到,先不讨论.
```

GPT表的位置,大小存储在gdtr(48位)寄存器中.

windbg:

```
kd> r gdtr
gdtr=8003f000
kd> r gdtl
gdtl=000003ff
kd> dq 8003f000 l10
ReadVirtual: 8003f000 not properly sign extended
8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008955`27000068 80008955`27680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff
```

------

段选择子:

16位,指向了定义该段的段描述符. 

![image-20230326202402680](./%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0.assets/image-20230326202402680.png)

```
RPL:
请求特权级别.

TI:
TI=0 查GDT表.	//因为Windows只使用了GDT表,所以TI总为1.
TI=1 查LDT表.

Index:
表的索引,0开始.
```

EX:

| 0x23  | 0010 0011 |      |
| ----- | --------- | ---- |
| Index | TI        | RPL  |
| 00100 | 0         | 11   |
| 0x2B  | 0010 1011 |      |
| Index | TI        | RPL  |
| 00101 | 0         | 11   |
| 0x30  | 0011 0000 |      |
| Index | TI        | RPL  |
| 00110 | 0         | 00   |
| 0x3B  | 0011 1011 |      |
| Index | TI        | RPL  |
| 00110 | 0         | 11   |
| 0x53  | 0101 0011 |      |
| Index | TI        | RPL  |
| 01010 | 0         | 11   |

------

段描述符:

32位,定义了该段的属性.

![image-20230326203632589](./%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0.assets/image-20230326203632589.png)

```
P->G->S->TYPE.

P(段限制):
定义了该段描述符是否有效.
1	有效.
0	无效.

G(粒度):
定义了Segment Limit的单位
0	byte,最大为0x000FFFFF,1MB.
1	4kb,最大为0xFFFFFFFF,4GB.

S(描述符类型):
0	system.
1	code或者data.

TYPE(段类型):
和S有关,此处略.
```

TYPE:

S = 1:

![image-20230326210024318](./%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0.assets/image-20230326210024318.png)

```
Data:
    A(accessed):
    访问位.
    W(Write):
    可写位.
    E(expand-down):
    拓展位.
```

向上拓展和向下拓展,红色为段空间,即向上拓展和向下拓展互为补集,全集的大小和D/B有关(16/32位寻址方式).

![image-20230326210514299](./%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0.assets/image-20230326210514299.png)

```
Code:
    A(accessed):
    访问位.
    R(Read):
    可读位.
    C(conforming):
    一致位,此处略.
```

S = 0:

![image-20230326210109852](./%E6%BB%B4%E6%B0%B4%E4%B8%89%E6%9C%9F%E4%B8%AD%E7%BA%A7%E7%AC%94%E8%AE%B0.assets/image-20230326210109852.png)

EX:

```
kd> dq 8003f000 l10
ReadVirtual: 8003f000 not properly sign extended
8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008955`27000068 80008955`27680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff

段选择子为0x23,00100 0 11,索引为4,00cff300`0000ffff.P位所在的f大于等于8,即P位为1,该段描述符有效,G位为1,S位为1,是code/data段,TYPE为3,Data段,权限为:Read/Write,accessed.
Base:00000000
Atrribute:cff3
Limit:0xffffffff

段选择子为0x2B,00101 01 1,索引为5,80008b04`200020ab.P位所在的8等于大于8,即P位为1,该段描述符有效,G位为0,S位为0,是system段,TYPE为11,权限为:32-Bit TSS(Busy).
Base:80042000
Atrribute:008b
Limit:0x0ffff000

段选择子为0x30,00110 0 00,索引为6,ffc093df`f0000001.P位所在的9等于大于8,即P位为1,该段描述符有效,G位为1,S位为1,是code/data段,TYPE为3,Data段,权限为:Read/Write,accessed.
Base:ffdff000
Atrribute:c093
Limit:0x00001fff

段选择子为0x3B,00111 0 11,索引为7,0040f300`00000fff.P位所在的f等于大于8,即P位为1,该段描述符有效,G位为0,S位为1,是code/data段,TYPE为3,Data段,权限为:Read/Write,accessed.
Base:00000000
Atrribute:40f3
Limit:0x00000fff

段选择子为0x53,01010 0 11,索引为10,80008955`27000068.P位所在的8等于大于8,即P位为1,该段描述符有效,G位为0,S位为0,是system段,TYPE为9,权限为:Available.
Base:80552700
Atrribute:0089
Limit:0x00000068
```

